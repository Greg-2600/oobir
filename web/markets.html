<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Markets - OOBIR</title>
        <link rel="stylesheet" href="styles.css">
        <style>
        body {
            background: radial-gradient(circle at 20% 20%, #eef4ff, #f8fafc 45%),
                        radial-gradient(circle at 80% 0%, #fef2f2, #f8fafc 40%),
                        #f8fafc;
            min-height: 100vh;
        }

        .stocks-page {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stocks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .stocks-header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stocks-header h1 {
            margin: 0;
            font-size: 2em;
            color: #1f2937;
        }

        .hero-subtitle {
            margin: 0;
            color: #475569;
            font-size: 1rem;
        }

        .hero-tags { display:flex; gap:10px; flex-wrap:wrap; }

        .logo-link {
            text-decoration: none;
            color: #3b82f6;
            font-weight: bold;
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.2s;
        }

        .logo-link:hover { color: #2563eb; }

        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 18px;
            margin-top: 20px;
        }

        .stock-card {
            position: relative;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 18px 18px 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(15,23,42,0.06);
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        .stock-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(59,130,246,0.06), rgba(59,130,246,0));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stock-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            opacity: 0.7;
        }

        .stock-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 38px rgba(15,23,42,0.12);
            border-color: #3b82f6;
        }

        .stock-card:hover::before { opacity: 1; }

        .stock-card[data-region="americas"]::after { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
        .stock-card[data-region="europe"]::after { background: linear-gradient(90deg, #6366f1, #a855f7); }
        .stock-card[data-region="apac"]::after { background: linear-gradient(90deg, #14b8a6, #22d3ee); }
        .stock-card[data-region="latam"]::after { background: linear-gradient(90deg, #f59e0b, #ef4444); }
        .stock-card[data-region="global"]::after { background: linear-gradient(90deg, #94a3b8, #cbd5e1); }

        .stock-card[data-region="americas"] { background: linear-gradient(180deg, rgba(59,130,246,0.05), rgba(6,182,212,0.02)); }
        .stock-card[data-region="europe"] { background: linear-gradient(180deg, rgba(99,102,241,0.05), rgba(168,85,247,0.02)); }
        .stock-card[data-region="apac"] { background: linear-gradient(180deg, rgba(20,184,166,0.05), rgba(34,211,238,0.02)); }
        .stock-card[data-region="latam"] { background: linear-gradient(180deg, rgba(245,158,11,0.05), rgba(239,68,68,0.02)); }
        .stock-card[data-region="global"] { background: linear-gradient(180deg, rgba(148,163,184,0.04), rgba(203,213,225,0.02)); }

        .stock-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stock-card-header .title-stack { display:flex; flex-direction:column; gap:6px; }

        .stock-ticker {
            font-size: 0.95em;
            font-weight: 400;
            color: #1f2937;
        }

        .stock-name { color: #1f2937; font-size: 1.25em; font-weight: 700; }
        .stock-meta { margin-top:6px; display:flex; align-items:center; gap:8px; color:#6b7280; font-size:0.9em; }
        .stock-meta .flag { font-size:18px; line-height:1; }
        .stock-meta .country { color:#6b7280 }
        .flag-large { display:block; font-size:20px; line-height:1; margin-bottom:6px }

        .stock-price { font-size: 1.1em; font-weight: 700; color: #1a73e8; }
        /* Trend color helpers: color whole card background for clearer signal */
        .stock-card.trend-up { background: linear-gradient(180deg, rgba(16,185,129,0.06), rgba(16,185,129,0.02)); border-color: rgba(16,185,129,0.2); box-shadow: 0 8px 24px rgba(16,185,129,0.06); }
        .stock-card.trend-down { background: linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02)); border-color: rgba(239,68,68,0.2); box-shadow: 0 8px 24px rgba(239,68,68,0.06); }
        .stock-card.trend-neutral { background: white; border-color: #e5e7eb; }
        .stock-card.trend-up .stock-price { color: #065f46; }
        .stock-card.trend-down .stock-price { color: #7f1d1d; }
        /* Ensure hover effect remains visible on colored cards */
        .stock-card.trend-up:hover, .stock-card.trend-down:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(2,6,23,0.12); }

        .stock-meta-row { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:0.8rem; font-weight:600; letter-spacing:0.01em; background: #eef2ff; color:#4338ca; border:1px solid rgba(79,70,229,0.2); }
        .pill.soft { background:#ecfeff; color:#0e7490; border-color:rgba(14,116,144,0.2); }
        .pill.neutral { background:#f8fafc; color:#475569; border-color:rgba(148,163,184,0.3); }

        .trend-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; font-size:0.82rem; font-weight:700; letter-spacing:0.01em; }
        .trend-badge.up { background: #ecfdf3; color: #166534; border:1px solid rgba(22,101,52,0.2); }
        .trend-badge.down { background: #fef2f2; color: #991b1b; border:1px solid rgba(153,27,27,0.2); }
        .trend-badge.flat { background: #f8fafc; color: #475569; border:1px solid rgba(148,163,184,0.3); }

        .mini-chart { height: 92px; border-radius: 10px; background: radial-gradient(circle at 20% 20%, #111827, #0b1220); display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:0.9em;border:1px solid #1f2937; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); }

        @media (max-width: 768px) {
            .stocks-grid { grid-template-columns: 1fr; }
        }
        </style>
    </head>
    <body>
        <div class="stocks-page">
            <div class="stocks-header">
                <div class="stocks-header-left">
                    <h1>üåê International Market Indexes</h1>
                    <p class="hero-subtitle">30-day mini candlesticks with trend tinting by region</p>
                    <div class="hero-tags">
                        <span class="pill">Live OHLC mini charts</span>
                        <span class="pill soft">Region-tinted cards</span>
                        <span class="pill neutral">Tap a card to drill in</span>
                    </div>
                </div>
                <a href="/" class="logo-link">OOBIR</a>
            </div>
            <div class="stocks-grid" id="markets-grid">
                <!-- US indexes first -->
                <div class="stock-card" data-ticker="^GSPC">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">S&amp;P 500</div>
                                <div class="stock-ticker">^GSPC</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá∫üá∏</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^GSPC">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^DJI">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Dow Jones Industrial Average</div>
                                <div class="stock-ticker">^DJI</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá∫üá∏</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^DJI">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^IXIC">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Nasdaq Composite</div>
                                <div class="stock-ticker">^IXIC</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá∫üá∏</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^IXIC">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^RUT">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Russell 2000</div>
                                <div class="stock-ticker">^RUT</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá∫üá∏</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^RUT">Loading...</div>
                    </div>
                </div>
                <!-- Non-US markets sorted by estimated market-cap size -->
                <div class="stock-card" data-ticker="000001.SS">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Shanghai Composite</div>
                                <div class="stock-ticker">000001.SS</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá®üá≥</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-000001.SS">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^N225">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Nikkei 225</div>
                                <div class="stock-ticker">^N225</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üáØüáµ</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^N225">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^FTSE">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">FTSE 100</div>
                                <div class="stock-ticker">^FTSE</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá¨üáß</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^FTSE">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^STOXX50E">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Euro Stoxx 50</div>
                                <div class="stock-ticker">^STOXX50E</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá™üá∫</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^STOXX50E">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^FCHI">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">CAC 40</div>
                                <div class="stock-ticker">^FCHI</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá´üá∑</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^FCHI">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^GDAXI">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">DAX</div>
                                <div class="stock-ticker">^GDAXI</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá©üá™</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^GDAXI">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^NSEI">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Nifty 50</div>
                                <div class="stock-ticker">^NSEI</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üáÆüá≥</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^NSEI">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^BSESN">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">BSE Sensex</div>
                                <div class="stock-ticker">^BSESN</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üáÆüá≥</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^BSESN">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^GSPTSE">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">S&amp;P/TSX Composite</div>
                                <div class="stock-ticker">^GSPTSE</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá®üá¶</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^GSPTSE">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^HSI">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Hang Seng</div>
                                <div class="stock-ticker">^HSI</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá≠üá∞</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^HSI">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^KS11">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">KOSPI</div>
                                <div class="stock-ticker">^KS11</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá∞üá∑</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^KS11">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^AXJO">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">ASX 200</div>
                                <div class="stock-ticker">^AXJO</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üá¶üá∫</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^AXJO">Loading...</div>
                    </div>
                </div>
                <div class="stock-card" data-ticker="^BVSP">
                    <div>
                        <div class="stock-card-header">
                            <div>
                                <div class="stock-name">Bovespa</div>
                                <div class="stock-ticker">^BVSP</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="flag-large">üáßüá∑</span>
                                <div class="stock-price">‚Äî</div>
                            </div>
                        </div>
                        <div class="mini-chart" data-container-id="chart-^BVSP">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <script src="config.js"></script>
        <script>
        const REGION_META = {
            '^GSPC': { code:'americas', label:'North America' },
            '^DJI': { code:'americas', label:'North America' },
            '^IXIC': { code:'americas', label:'North America' },
            '^RUT': { code:'americas', label:'North America' },
            '^GSPTSE': { code:'americas', label:'North America' },
            '^BVSP': { code:'latam', label:'Latin America' },
            '000001.SS': { code:'apac', label:'Asia Pacific' },
            '^N225': { code:'apac', label:'Asia Pacific' },
            '^HSI': { code:'apac', label:'Asia Pacific' },
            '^KS11': { code:'apac', label:'Asia Pacific' },
            '^AXJO': { code:'apac', label:'Asia Pacific' },
            '^NSEI': { code:'apac', label:'Asia Pacific' },
            '^BSESN': { code:'apac', label:'Asia Pacific' },
            '^FTSE': { code:'europe', label:'Europe' },
            '^STOXX50E': { code:'europe', label:'Europe' },
            '^FCHI': { code:'europe', label:'Europe' },
            '^GDAXI': { code:'europe', label:'Europe' },
        };

        // Navigate to index with ticker query when a card is clicked
        document.getElementById('markets-grid').addEventListener('click', function(e){
            let el = e.target;
            while(el && !el.classList.contains('stock-card')) el = el.parentElement;
            if(!el) return;
            const ticker = el.getAttribute('data-ticker');
            if(ticker) window.location.href = 'index.html?ticker=' + encodeURIComponent(ticker);
        });

        // Draw a compact candlestick chart into the container using OHLC data
        function drawCandles(container, data){
            container.innerHTML = '';
            if(!data || data.length === 0){ container.textContent = 'No data'; return; }

            // Normalize to numeric OHLC
            const series = data.map(pt => ({
                open: Number(pt.Open ?? pt.open ?? pt.o ?? NaN),
                high: Number(pt.High ?? pt.high ?? pt.h ?? NaN),
                low: Number(pt.Low ?? pt.low ?? pt.l ?? NaN),
                close: Number(pt.Close ?? pt.close ?? pt.c ?? NaN),
            })).filter(p => !isNaN(p.open) && !isNaN(p.high) && !isNaN(p.low) && !isNaN(p.close));
            if(series.length === 0){ container.textContent = 'No data'; return; }

            const w = container.clientWidth || 300;
            const h = container.clientHeight || 80;
            const padding = 6;

            const allPrices = series.flatMap(p => [p.high, p.low]);
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);
            const range = maxPrice - minPrice || 1;

            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', h);
            svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

            const barWidth = Math.max(2, (w / series.length) * 0.6);
            const step = w / Math.max(1, series.length - 1);

            series.forEach((p, i) => {
                const x = i * step;
                const yHigh = padding + ((maxPrice - p.high) / range) * (h - padding*2);
                const yLow = padding + ((maxPrice - p.low) / range) * (h - padding*2);
                const yOpen = padding + ((maxPrice - p.open) / range) * (h - padding*2);
                const yClose = padding + ((maxPrice - p.close) / range) * (h - padding*2);

                // wick
                const wick = document.createElementNS(svgNS, 'line');
                wick.setAttribute('x1', x);
                wick.setAttribute('x2', x);
                wick.setAttribute('y1', yHigh);
                wick.setAttribute('y2', yLow);
                wick.setAttribute('stroke', '#e5e7eb');
                wick.setAttribute('stroke-width', Math.max(1, barWidth/6));
                wick.setAttribute('stroke-linecap', 'round');
                svg.appendChild(wick);

                // body
                const isUp = p.close >= p.open;
                const body = document.createElementNS(svgNS, 'rect');
                const bodyTop = Math.min(yOpen, yClose);
                const bodyHeight = Math.max(1, Math.abs(yClose - yOpen));
                body.setAttribute('x', x - barWidth/2);
                body.setAttribute('y', bodyTop);
                body.setAttribute('width', barWidth);
                body.setAttribute('height', bodyHeight);
                body.setAttribute('fill', isUp ? '#4ade80' : '#f87171');
                body.setAttribute('stroke', isUp ? '#22c55e' : '#ef4444');
                body.setAttribute('stroke-width', '0.5');
                svg.appendChild(body);
            });

            const last = series[series.length-1];
            container.appendChild(svg);

            // Move the latest close price into the card's `.stock-price` element (under the flag)
            const card = container.closest('.stock-card');
            if(card){
                const priceEl = card.querySelector('.stock-price');
                if(priceEl) priceEl.textContent = last.close.toFixed(2);
            }
        }

        function decorateCard(card, ticker){
            // Set region tint and label
            const meta = REGION_META[ticker] || { code:'global', label:'Global' };
            card.setAttribute('data-region', meta.code);

            // Inject meta row once
            if(!card.querySelector('.stock-meta-row')){
                const header = card.querySelector('.stock-card-header');
                const row = document.createElement('div');
                row.className = 'stock-meta-row';
                row.innerHTML = `
                    <span class="pill region-pill region-label">${meta.label}</span>
                    <span class="pill soft">30d mini chart</span>
                `;
                if(header && header.parentNode){
                    header.parentNode.insertBefore(row, header.nextSibling);
                }
            } else {
                const label = card.querySelector('.region-label');
                if(label) label.textContent = meta.label;
            }
        }

        function setTrendBadge(card, direction, pct){
            let badge = card.querySelector('.trend-badge');
            if(!badge){
                badge = document.createElement('span');
                badge.className = 'trend-badge flat';
                const row = card.querySelector('.stock-meta-row') || card.querySelector('.stock-card-header');
                if(row && row.parentNode){
                    row.parentNode.insertBefore(badge, row.nextSibling);
                } else {
                    card.insertBefore(badge, card.firstChild);
                }
            }
            badge.classList.remove('up','down','flat');
            const pctText = isFinite(pct) ? (pct * 100).toFixed(1) + '% over 5d' : 'Flat';
            if(direction === 'up'){
                badge.classList.add('trend-badge','up');
                badge.textContent = 'Up ' + pctText;
            } else if(direction === 'down'){
                badge.classList.add('trend-badge','down');
                badge.textContent = 'Down ' + pctText;
            } else {
                badge.classList.add('trend-badge','flat');
                badge.textContent = 'Flat 5d';
            }
        }

        async function loadMarketCharts(){
            const apiBase = (typeof window !== 'undefined' && window.OOBIR_API_BASE)
                ? window.OOBIR_API_BASE
                : (window.location.hostname === 'localhost'
                    ? 'http://localhost:8000'
                    : `${window.location.protocol}//${window.location.hostname}:8000`);
            const cards = document.querySelectorAll('.stock-card');
            for(const card of cards){
                const ticker = card.getAttribute('data-ticker');
                const chartEl = card.querySelector('.mini-chart');
                const priceEl = card.querySelector('.stock-price');
                if(!ticker || !chartEl) continue;
                decorateCard(card, ticker);
                try{
                    const res = await fetch(`${apiBase}/api/price-history/${encodeURIComponent(ticker)}?days=30`);
                    if(!res.ok){ chartEl.textContent = 'No data'; continue; }
                    let json = await res.json();
                    let data = [];
                    if(Array.isArray(json)) data = json;
                    else if(json.data && Array.isArray(json.data)) data = json.data;
                    else if(json.prices && Array.isArray(json.prices)) data = json.prices;
                    // Pass recent OHLC points to candlestick drawer
                    const recent = data.slice(-30);
                    if(!recent || recent.length === 0){
                        chartEl.textContent = 'No data';
                        if(priceEl) priceEl.textContent = '‚Äî';
                        continue;
                    }
                    drawCandles(chartEl, recent);
                    // compute a 5-day slope (percent change over 5 trading points) and tint card stronger for larger moves
                    try{
                        const closes = recent.map(p => Number(p.Close ?? p.close ?? p.c ?? NaN)).filter(v => !isNaN(v));
                        card.classList.remove('trend-up','trend-down','trend-neutral');
                        if(closes.length >= 5){
                            const last = closes[closes.length-1];
                            const prior = closes[closes.length-5];
                            const pct = prior === 0 ? 0 : (last - prior) / Math.abs(prior);
                            const direction = pct > 0 ? 'up' : (pct < 0 ? 'down' : 'neutral');
                            setTrendBadge(card, direction === 'neutral' ? 'flat' : direction, pct);
                        } else if(closes.length >= 2){
                            const last = closes[closes.length-1];
                            const prev = closes[closes.length-2];
                            const pct = prev === 0 ? 0 : (last - prev) / Math.abs(prev);
                            const direction = last > prev ? 'up' : (last < prev ? 'down' : 'flat');
                            setTrendBadge(card, direction, pct);
                        } else {
                            setTrendBadge(card, 'flat', 0);
                        }
                    }catch(e){
                        card.classList.remove('trend-up','trend-down');
                        card.classList.add('trend-neutral');
                        card.style.background = '';
                        card.style.borderColor = '';
                        setTrendBadge(card, 'flat', 0);
                    }
                }catch(err){
                    chartEl.textContent = 'Error';
                    if(priceEl) priceEl.textContent = '‚Äî';
                    console.error('market chart error', ticker, err);
                }
            }
        }

        // Run after DOM ready
        if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadMarketCharts);
        else loadMarketCharts();
        </script>
    </body>
</html>
